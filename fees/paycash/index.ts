/**
 * PayCashSwap Fees Adapter
 * 
 * This adapter calculates the fees generated by PayCashSwap based on the provided fee structure.
 * For each exchange operation in the pools, a commission of 0.25% of the exchange sum is charged.
 * - 0.2% is distributed proportionally among liquidity providers.
 * - 0.05% is directed towards the burning of the reward token Crypto Malinka (MLNK).
 * 
 * @source https://paycashswap.com/info
 */

import { Adapter, FetchOptions } from "../../adapters/types";
import { CHAIN } from "../../helpers/chains";
import { getUniqStartOfTodayTimestamp } from "../../helpers/getUniSubgraphVolume";
import { httpPost } from "../../utils/fetchURL";

const historicalVolumeEndpoint = "https://api.paycashswap.com/";
const requestBody = {
  operationName: "TotalVolume",
  query: "query TotalVolume {\n  totalVolumeChart {\n    value24h\n    lastWeekValue\n    percentageChange24h\n    points {\n      timestamp\n      value\n    }\n  }\n}\n",
  variables: {}
};


const fetch = async (timestamp: number, _, options: FetchOptions) => {
  const dayTimestamp = getUniqStartOfTodayTimestamp(new Date(timestamp * 1000));
  const historicalVolume = (await httpPost(historicalVolumeEndpoint, requestBody))?.data.totalVolumeChart.points;
  const dailyVolume = historicalVolume
    .find(dayItem => (new Date(dayItem.timestamp).getTime() / 1000) === dayTimestamp)?.value;

  const totalVolume = historicalVolume
    .filter(volItem => (new Date(volItem.timestamp).getTime() / 1000) <= dayTimestamp)
    .reduce((acc, { value }) => acc + Number(value), 0)

  const dailyFees = Number(dailyVolume) * 0.0025;
  const dailyLiquidityProviderFee = Number(dailyVolume) * 0.002;
  const dailyBurnFee = Number(dailyVolume) * 0.0005;

  const dailyHoldersRevenue = dailyBurnFee;
  const dailyProtocolRevenue = 0; // Assuming no separate protocol revenue
  const dailyRevenue = dailyHoldersRevenue + dailyProtocolRevenue;

  const totalFees = totalVolume * 0.0025;
  const totalLiquidityProviderFee = totalVolume * 0.002;
  const totalBurnFee = totalVolume * 0.0005;
  const totalHoldersRevenue = totalBurnFee;
  const totalProtocolRevenue = 0; // Assuming no separate protocol revenue
  const totalRevenue = totalHoldersRevenue + totalProtocolRevenue;

  return {
    dailyFees,
    dailyRevenue,
    dailyUserFees: dailyFees,
    dailyProtocolRevenue: dailyProtocolRevenue,
    dailyHoldersRevenue: dailyHoldersRevenue,
    dailySupplySideRevenue: dailyLiquidityProviderFee,
    totalFees,
    totalUserFees: totalFees,
    totalRevenue: totalRevenue,
    totalProtocolRevenue: totalProtocolRevenue,
    totalSupplySideRevenue: totalLiquidityProviderFee
  };
};

const adapter: Adapter = {
  version: 1,
  adapter: {
    [CHAIN.EOS]: {
      fetch,
      start: '2021-04-14',
      meta: {
        methodology: "Fees are calculated based on a 0.25% commission on each exchange operation, distributed as 0.2% to liquidity providers and 0.05% for token burning."
      }
    },
  },
};

export default adapter;
