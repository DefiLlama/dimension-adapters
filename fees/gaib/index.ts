// DefiLlama Fees / Revenue Adapter for GAIB
// Repo: DefiLlama/dimension-adapters
// Path: fees/gaib/index.ts
//
// Fees     = Gross yield generated by sAID vault (totalAssets growth)
// Revenue  = Protocol spread — what GAIB keeps (~20% of gross yield)
//
// Derived from live data:
//   Gross APR: 14.82%  →  Net APR: 11.85%
//   Spread = 1 - (11.85 / 14.82) ≈ 20.04%

import { Adapter, FetchOptions } from "../../adapters/types";
import { CHAIN } from "../../helpers/chains";

const SAID_VAULT = "0xB3B3c527BA57cd61648e2EC2F5e006A0B390A9F8";
const DAI = "0x6B175474E89094C44Da98b954EedeAC495271d0F";

const ONE = BigInt(1e18);
const ABI = {
  convertToAssets: "function convertToAssets(uint256) view returns (uint256)",
  totalSupply: "uint256:totalSupply",
};

const fetch = async (options: FetchOptions) => {
  const { api, createBalances } = options;

  const dailyFees = createBalances();
  const dailyRevenue = createBalances();

  // Share price (AID per 1 sAID) at end and start of period
  const [priceEnd] = await api.multiCall({ abi: ABI.convertToAssets, calls: [{ target: SAID_VAULT, params: [ONE.toString()] }] });
  const [priceStart] = await options.fromApi.multiCall({ abi: ABI.convertToAssets, calls: [{ target: SAID_VAULT, params: [ONE.toString()] }] });

  // totalSupply of sAID shares at end of period
  const [totalSupply] = await api.multiCall({ abi: ABI.totalSupply, calls: [SAID_VAULT] });

  const priceDelta = BigInt(priceEnd) - BigInt(priceStart);

  if (priceDelta > 0n) {
    // Share price growth = net yield (vault receives 80% after protocol cut)
    const netYield = (BigInt(totalSupply) * priceDelta) / ONE;

    // Gross yield = net / 0.8 (protocol takes 20% before injecting into vault)
    const grossYield = (netYield * 10000n) / 8000n;
    const revenue = grossYield - netYield;

    // Using DAI (18 decimals) as pricing proxy (AID ≈ $1)
    dailyFees.add(DAI, grossYield);
    dailyRevenue.add(DAI, revenue);
  }

  return {
    dailyFees,
    dailyRevenue,
  };
};

const adapter: Adapter = {
  version: 2,
  methodology: {
    Fees: "Total yield generated by the sAID vault portfolio (AI infrastructure financing + T-bills). Measured as the increase in vault totalAssets over the period.",
    Revenue: "Protocol spread — ~20% of gross yield retained by GAIB as management fee. Derived from gross APR (14.82%) vs net APR (11.85%) to sAID holders.",
  },
  adapter: {
    [CHAIN.ETHEREUM]: {
      fetch,
      start: 1733011200, // Dec 1, 2024 — sAID yield accrual start
    },
  },
};

export default adapter;
