import { FetchOptions, SimpleAdapter } from "../../adapters/types";
import { CHAIN } from "../../helpers/chains";
import { httpPost, httpGet } from "../../utils/fetchURL";
import { getEnv } from "../../helpers/env";

const SENTIO_API_URL =
  "https://api.sentio.xyz/v1/analytics/navi/volo-vault/sql/execute";

const DAILY_FEE_SQL = `
WITH eod AS (
  SELECT toDate(timestamp, 'UTC') AS day, coin_symbol,
    argMax(total_active_cumulated, timestamp) AS eod_cumulated
  FROM PerformanceFeeRecord
  GROUP BY day, coin_symbol
)
SELECT day, coin_symbol,
  greatest((eod_cumulated - lag(eod_cumulated, 1, eod_cumulated) 
    OVER (PARTITION BY coin_symbol ORDER BY day)), toDecimal128(0, 18)) AS daily_fee
FROM eod ORDER BY day, coin_symbol`;

const COIN_MAP: Record<string, string> = {
  suiBTC: "bitcoin",
  XBTC: "bitcoin",
  nUSDC: "usd-coin",
};

const methodology = {
  Fees: "Performance fees collected from Volo vault yield strategies.",
  Revenue: "Total yield generated by vaults.",
  ProtocolRevenue: "Performance fees retained by protocol.",
};

const fetch = async ({ endTimestamp }: FetchOptions) => {
  const dateString = new Date(endTimestamp * 1000).toISOString().split("T")[0];

  const response: any = await httpPost(
    SENTIO_API_URL,
    {
      version: 85,
      sqlQuery: { sql: DAILY_FEE_SQL, size: 10000 },
      cachePolicy: {
        noCache: false,
        cacheTtlSecs: 1036800,
        cacheRefreshTtlSecs: 43200,
      },
      engine: "DEFAULT",
    },
    {
      headers: {
        "Content-Type": "application/json",
        "api-key": getEnv("VOLO_VAULT_API_KEY"),
      },
    }
  );

  const fees: Record<string, number> = {};
  for (const row of response.result.rows) {
    if (row.day.split("T")[0] === dateString && COIN_MAP[row.coin_symbol]) {
      fees[row.coin_symbol] = parseFloat(row.daily_fee) || 0;
    }
  }

  const cgIds = [...new Set(Object.keys(fees).map((c) => COIN_MAP[c]))].join(
    ","
  );
  const priceRes = await httpGet(
    `https://coins.llama.fi/prices/historical/${endTimestamp}/coingecko:${cgIds}`
  );

  let dailyFees = 0;
  for (const [coin, fee] of Object.entries(fees)) {
    dailyFees +=
      fee * (priceRes.coins[`coingecko:${COIN_MAP[coin]}`]?.price || 0);
  }

  return {
    dailyFees,
    dailyRevenue: dailyFees * 5,
    dailyProtocolRevenue: dailyFees,
  };
};

const adapter: SimpleAdapter = {
  version: 2,
  adapter: {
    [CHAIN.SUI]: {
      fetch,
      start: "2025-08-10",
    },
  },
  methodology,
};

export default adapter;
